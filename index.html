<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1-3ë°˜ ë¯¸ë‹ˆí™ˆí”¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
        }
        .minihompy-container {
            max-width: 1000px;
            margin: 20px auto;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            overflow: hidden;
        }
        .sidebar {
            width: 250px;
            background-color: #f9fafb; /* ì‚¬ì´ë“œë°” ë°°ê²½ */
            border-right: 1px solid #e5e7eb;
            padding: 20px;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 90vh;
        }
        .profile-box {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        .profile-pic {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 12px;
            object-fit: cover;
            border: 3px solid #e5e7eb;
        }
        .menu-item {
            display: block;
            padding: 10px 12px;
            border-radius: 6px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .menu-item:hover, .menu-item.active {
            background-color: #e5e7eb; /* ë©”ë‰´ í˜¸ë²„/í™œì„± */
            color: #111827;
        }
        .content-section {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¹€ */
            animation: fadeIn 0.5s;
        }
        .content-section.active {
            display: block; /* í™œì„± ì„¹ì…˜ë§Œ í‘œì‹œ */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-top: 6px;
        }
        .btn {
            padding: 10px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }
        .btn-primary {
            background-color: #3b82f6; /* íŒŒë€ìƒ‰ ë²„íŠ¼ */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- ë¡œë”© ë·° -->
    <div id="loading-view" class="modal hidden">
        <div class="loader"></div>
    </div>

    <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ ë·° -->
    <div id="error-view" class="modal hidden">
        <div class="modal-content text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">ì˜¤ë¥˜ ë°œìƒ</h3>
            <p id="error-message" class="mb-6"></p>
            <button id="close-error-btn" class="btn btn-primary">í™•ì¸</button>
        </div>
    </div>

    <!-- ì¸ì¦ ì½”ë“œ ì…ë ¥ ë·° -->
    <div id="auth-code-view" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold text-center mb-6">1-3ë°˜ ë¯¸ë‹ˆí™ˆí”¼</h2>
        <p class="text-center text-gray-600 mb-6">ê´€ë¦¬ìì—ê²Œ ë°›ì€ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <div>
            <label for="auth-code-input" class="block text-sm font-medium text-gray-700">ì¼íšŒìš© ì¸ì¦ ì½”ë“œ</label>
            <input type="text" id="auth-code-input" class="form-input" placeholder="ì˜ˆ: CLASS1-3ABC">
        </div>
        <button id="auth-code-submit-btn" class="btn btn-primary w-full mt-6">ì¸ì¦í•˜ê¸°</button>
        <p class="text-center text-gray-500 text-sm mt-4">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <span id="show-login-link" class="text-blue-600 cursor-pointer hover:underline">ë¡œê·¸ì¸</span></p>
    </div>

    <!-- íšŒì›ê°€ì… ë·° -->
    <div id="signup-view" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg hidden">
        <h2 class="text-2xl font-bold text-center mb-6">íšŒì›ê°€ì…</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">ì´ë©”ì¼ (ë¡œê·¸ì¸ ID)</label>
                <input type="email" id="signup-email" class="form-input" placeholder="your@email.com">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)</label>
                <input type="password" id="signup-password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">ì´ë¦„ (ì‹¤ëª…)</label>
                <input type="text" id="signup-name" class="form-input" placeholder="í™ê¸¸ë™">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">ë³„ëª… (2~10ì, í•œ/ì˜/ìˆ«ì)</label>
                <input type="text" id="signup-nickname" class="form-input" placeholder="ë©‹ì§„ ê¸¸ë™ì´">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">í”„ë¡œí•„ ì‚¬ì§„</label>
                <input type="file" id="signup-profile-pic" class="form-input" accept="image/png, image/jpeg">
            </div>
        </div>
        <button id="signup-submit-btn" class="btn btn-primary w-full mt-6">ê°€ì…í•˜ê¸°</button>
        <p class="text-center text-gray-500 text-sm mt-4"><span id="show-login-link-2" class="text-blue-600 cursor-pointer hover:underline">ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span></p>
    </div>

    <!-- ë¡œê·¸ì¸ ë·° -->
    <div id="login-view" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg hidden">
        <h2 class="text-2xl font-bold text-center mb-6">ë¡œê·¸ì¸</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">ì´ë©”ì¼</label>
                <input type="email" id="login-email" class="form-input" placeholder="your@email.com">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="login-password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
        </div>
        <button id="login-submit-btn" class="btn btn-primary w-full mt-6">ë¡œê·¸ì¸</button>
        <p class="text-center text-gray-500 text-sm mt-4">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span id="show-auth-code-link" class="text-blue-600 cursor-pointer hover:underline">ì¸ì¦ ì½”ë“œë¡œ ê°€ì…í•˜ê¸°</span></p>
    </div>

    <!-- ë¯¸ë‹ˆí™ˆí”¼ ë©”ì¸ ë·° -->
    <div id="minihompy-view" class="minihompy-container hidden">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar">
            <div class="profile-box mb-6">
                <img id="profile-pic" src="https://placehold.co/120x120/e0e0e0/757575?text=Profile" alt="Profile Picture" class="profile-pic">
                <h3 id="profile-nickname" class="text-lg font-semibold text-gray-800"></h3>
                <p id="profile-bio" class="text-sm text-gray-500 mt-1"></p>
                <button id="edit-profile-btn" class="btn btn-secondary w-full mt-4 text-sm">í”„ë¡œí•„ ìˆ˜ì •</button>
            </div>
            <nav class="space-y-2">
                <a class="menu-item active" data-target="home">ğŸ  í™ˆ</a>
                <a class="menu-item" data-target="posts">ğŸ“– ë‹¤ì´ì–´ë¦¬</a>
                <a class="menu-item" data-target="guestbook">ğŸ‘¥ ë°©ëª…ë¡</a>
                <!-- <a class="menu-item" data-target="friends">ğŸ§‘â€ğŸ¤â€ğŸ§‘ ì¼ì´Œ</a> -->
                <a id="logout-btn" class="menu-item text-red-500 hover:bg-red-100">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
            </nav>
        </aside>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <!-- í™ˆ ì„¹ì…˜ -->
            <section id="content-home" class="content-section active">
                <h2 class="text-2xl font-bold mb-4">ë‚´ ë¯¸ë‹ˆí™ˆí”¼</h2>
                <div class="card">
                    <h3 class="font-semibold text-lg mb-2">í”„ë¡œí•„ ì •ë³´</h3>
                    <p><strong>ì´ë¦„:</strong> <span id="home-name"></span></p>
                    <p><strong>ë³„ëª…:</strong> <span id="home-nickname"></span></p>
                    <p><strong>ì´ë©”ì¼:</strong> <span id="home-email"></span></p>
                    <p><strong>ìê¸°ì†Œê°œ:</strong> <span id="home-bio"></span></p>
                    <p><strong>ê´€ì‹¬ì‚¬:</strong> <span id="home-interests"></span></p>
                    <p><strong>ê³µê°œë²”ìœ„:</strong> <span id="home-visibility"></span></p>
                </div>
            </section>

            <!-- ë‹¤ì´ì–´ë¦¬(ê²Œì‹œê¸€) ì„¹ì…˜ -->
            <section id="content-posts" class="content-section">
                <h2 class="text-2xl font-bold mb-4">ë‹¤ì´ì–´ë¦¬ ğŸ“–</h2>
                <div class="card mb-6">
                    <h3 class="font-semibold text-lg mb-2">ìƒˆ ê¸€ ì“°ê¸°</h3>
                    <textarea id="post-content-input" class="form-input" rows="3" placeholder="ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì€?"></textarea>
                    <input type="file" id="post-image-input" class="form-input mt-2" accept="image/png, image/jpeg">
                    <button id="create-post-btn" class="btn btn-primary mt-3">ê¸€ì“°ê¸°</button>
                </div>
                <div id="posts-list" class="space-y-4">
                    <!-- ê²Œì‹œê¸€ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </section>

            <!-- ë°©ëª…ë¡ ì„¹ì…˜ -->
            <section id="content-guestbook" class="content-section">
                <h2 class="text-2xl font-bold mb-4">ë°©ëª…ë¡ ğŸ‘¥</h2>
                <div class="card mb-6">
                    <h3 class="font-semibold text-lg mb-2">ë°©ëª…ë¡ ë‚¨ê¸°ê¸°</h3>
                    <textarea id="guestbook-content-input" class="form-input" rows="2" placeholder="ì•ˆë…•! ì˜ ë³´ê³  ê°€~"></textarea>
                    <button id="create-guestbook-btn" class="btn btn-primary mt-3">ë‚¨ê¸°ê¸°</button>
                </div>
                <div id="guestbook-list" class="space-y-4">
                    <!-- ë°©ëª…ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </section>
        </main>
    </div>

    <!-- í”„ë¡œí•„ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="edit-profile-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">í”„ë¡œí•„ ìˆ˜ì •</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ë³„ëª… (2~10ì, í•œ/ì˜/ìˆ«ì)</label>
                    <input type="text" id="edit-nickname" class="form-input">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ìê¸°ì†Œê°œ</label>
                    <textarea id="edit-bio" class="form-input" rows="3"></textarea>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">ê´€ì‹¬ì‚¬ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                    <input type="text" id="edit-interests" class="form-input" placeholder="ì˜ˆ: ì½”ë”©, ìŒì•…, ë†êµ¬">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</label>
                    <input type="file" id="edit-profile-pic" class="form-input" accept="image/png, image/jpeg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">í”„ë¡œí•„ ê³µê°œ ë²”ìœ„</label>
                    <select id="edit-visibility" class="form-input">
                        <option value="public">ì „ì²´ ê³µê°œ</option>
                        <option value="friends">ì¹œêµ¬ ê³µê°œ</option>
                        <option value="private">ë¹„ê³µê°œ</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-edit-profile-btn" class="btn btn-secondary">ì·¨ì†Œ</button>
                <button id="save-edit-profile-btn" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase SDK ì„í¬íŠ¸ (v11.6.1 ê¸°ì¤€)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            addDoc,
            updateDoc,
            collection,
            query,
            where,
            onSnapshot,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ì‚¬ìš©ìê°€ ì œê³µí•œ Firebase êµ¬ì„±
        const firebaseConfig = {
            apiKey: "AIzaSyAlR_ctIhpsykWYJi_W6iYIeM3lUpFe5Pk",
            authDomain: "pr-2128d.firebaseapp.com",
            projectId: "pr-2128d",
            storageBucket: "pr-2128d.firebasestorage.app",
            messagingSenderId: "915082414403",
            appId: "1:915082414403:web:1dbb554c05288b09a387f6"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let validInvitationCode = null; // íšŒì›ê°€ì… ì‹œ ì‚¬ìš©í•  ìœ íš¨í•œ ì½”ë“œ
        let userProfile = null; // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í”„ë¡œí•„

        // UI ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const loadingView = document.getElementById('loading-view');
        const errorView = document.getElementById('error-view');
        const errorMessage = document.getElementById('error-message');
        const closeErrorBtn = document.getElementById('close-error-btn');

        const authCodeView = document.getElementById('auth-code-view');
        const signupView = document.getElementById('signup-view');
        const loginView = document.getElementById('login-view');
        const minihompyView = document.getElementById('minihompy-view');

        // ë·° ì „í™˜ í•¨ìˆ˜
        function showView(viewToShow) {
            [authCodeView, signupView, loginView, minihompyView].forEach(view => {
                view.classList.add('hidden');
            });
            if (viewToShow) {
                viewToShow.classList.remove('hidden');
            }
        }

        // ë¡œë”© ë° ì˜¤ë¥˜ ì²˜ë¦¬
        function showLoading(show) {
            loadingView.classList.toggle('hidden', !show);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorView.classList.remove('hidden');
        }

        closeErrorBtn.addEventListener('click', () => {
            errorView.classList.add('hidden');
        });

        // 1. ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ
        onAuthStateChanged(auth, async (user) => {
            showLoading(true);
            if (user) {
                currentUser = user;
                await fetchAndRenderUserProfile(user.uid);
                showView(minihompyView);
            } else {
                currentUser = null;
                userProfile = null;
                showView(authCodeView); // ë¡œê·¸ì•„ì›ƒ ì‹œ ì¸ì¦ ì½”ë“œ ë·°ë¡œ
            }
            showLoading(false);
        });

        // ì‚¬ìš©ì í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸° ë° ë Œë”ë§
        async function fetchAndRenderUserProfile(uid) {
            try {
                const userDocRef = doc(db, "users", uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    userProfile = { id: userDoc.id, ...userDoc.data() };
                    renderProfileData(userProfile);
                    // í™ˆí”¼ ì£¼ì¸ì´ í˜„ì¬ ìœ ì €ì´ë¯€ë¡œ, ì´ ìœ ì €ì˜ ê²Œì‹œê¸€ê³¼ ë°©ëª…ë¡ì„ ë¡œë“œ
                    loadPosts(uid);
                    loadGuestbook(uid);
                } else {
                    showError("ì‚¬ìš©ì í”„ë¡œí•„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê°•ì œ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.");
                    await signOut(auth);
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                showError(`í”„ë¡œí•„ ë¡œë”© ì˜¤ë¥˜: ${error.message}`);
                await signOut(auth);
            }
        }

        // í”„ë¡œí•„ ë°ì´í„°ë¥¼ UIì— ë°”ì¸ë”©
        function renderProfileData(profile) {
            // ì‚¬ì´ë“œë°”
            document.getElementById('profile-pic').src = profile.profilePicUrl || 'https://placehold.co/120x120/e0e0e0/757575?text=Profile';
            document.getElementById('profile-nickname').textContent = profile.nickname;
            document.getElementById('profile-bio').textContent = profile.bio || "ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.";

            // í™ˆ íƒ­
            document.getElementById('home-name').textContent = profile.name;
            document.getElementById('home-nickname').textContent = profile.nickname;
            document.getElementById('home-email').textContent = profile.email;
            document.getElementById('home-bio').textContent = profile.bio || "-";
            document.getElementById('home-interests').textContent = profile.interests ? profile.interests.join(', ') : "-";
            document.getElementById('home-visibility').textContent = profile.visibility || "ì „ì²´ ê³µê°œ";
        }

        // 2. ë·° ì „í™˜ ë§í¬
        document.getElementById('show-login-link').addEventListener('click', () => showView(loginView));
        document.getElementById('show-login-link-2').addEventListener('click', () => showView(loginView));
        document.getElementById('show-auth-code-link').addEventListener('click', () => showView(authCodeView));

        // 3. ì¸ì¦ ì½”ë“œ í™•ì¸
        document.getElementById('auth-code-submit-btn').addEventListener('click', async () => {
            const code = document.getElementById('auth-code-input').value.trim();
            if (!code) {
                showError("ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            showLoading(true);
            try {
                const codeDocRef = doc(db, "invitationCodes", code);
                const codeDoc = await getDoc(codeDocRef);

                if (!codeDoc.exists()) {
                    showError("ìœ íš¨í•˜ì§€ ì•Šì€ ì¸ì¦ ì½”ë“œì…ë‹ˆë‹¤.");
                } else if (codeDoc.data().used) {
                    showError("ì´ë¯¸ ì‚¬ìš©ëœ ì¸ì¦ ì½”ë“œì…ë‹ˆë‹¤.");
                } else if (codeDoc.data().class === "1-3") {
                    validInvitationCode = code; // ì½”ë“œ ì €ì¥
                    showView(signupView); // íšŒì›ê°€ì… ë·°ë¡œ
                } else {
                    showError("ì´ ì½”ë“œëŠ” 1-3ë°˜ ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error("Error checking auth code:", error);
                showError(`ì¸ì¦ ì˜¤ë¥˜: ${error.message}`);
            }
            showLoading(false);
        });

        // 4. íšŒì›ê°€ì… ì²˜ë¦¬
        const nicknameRegex = /^[a-zA-Z0-9ã„±-ã…ã…-ã…£ê°€-í£]{2,10}$/;
        document.getElementById('signup-submit-btn').addEventListener('click', async () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const name = document.getElementById('signup-name').value;
            const nickname = document.getElementById('signup-nickname').value;
            const file = document.getElementById('signup-profile-pic').files[0];

            // 1. ìœ íš¨ì„± ê²€ì‚¬
            if (!validInvitationCode) {
                showError("ì¸ì¦ ì½”ë“œê°€ í™•ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
                showView(authCodeView);
                return;
            }
            if (!email || !password || !name || !nickname || !file) {
                showError("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ê³  í”„ë¡œí•„ ì‚¬ì§„ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }
            if (password.length < 6) {
                showError("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }
            if (!nicknameRegex.test(nickname)) {
                showError("ë³„ëª…ì€ 2~10ìì˜ í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB ìš©ëŸ‰ ì œí•œ
                showError("í”„ë¡œí•„ ì‚¬ì§„ì€ 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            showLoading(true);

            try {
                // 2. ë‹‰ë„¤ì„ ì¤‘ë³µ ê²€ì‚¬
                const nicknameQuery = query(collection(db, "users"), where("nickname", "==", nickname));
                const nicknameSnapshot = await getDocs(nicknameQuery);
                if (!nicknameSnapshot.empty) {
                    showError("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë³„ëª…ì…ë‹ˆë‹¤.");
                    showLoading(false);
                    return;
                }

                // 3. Firebase Auth íšŒì› ìƒì„±
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 4. í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ
                const storageRef = ref(storage, `profilePics/${user.uid}/${file.name}`);
                await uploadBytes(storageRef, file);
                const profilePicUrl = await getDownloadURL(storageRef);

                // 5. Firestoreì— ì‚¬ìš©ì í”„ë¡œí•„ ì €ì¥
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    email: email,
                    name: name,
                    nickname: nickname,
                    profilePicUrl: profilePicUrl,
                    bio: `ì•ˆë…•í•˜ì„¸ìš”! ${nickname}ì…ë‹ˆë‹¤.`,
                    interests: [],
                    visibility: "public",
                    class: "1-3", // ë°˜ ì •ë³´ íƒœê·¸
                    createdAt: serverTimestamp()
                });

                // 6. ì´ˆëŒ€ ì½”ë“œ ì‚¬ìš© ì²˜ë¦¬
                await updateDoc(doc(db, "invitationCodes", validInvitationCode), {
                    used: true,
                    usedBy: user.uid,
                    usedAt: serverTimestamp()
                });

                validInvitationCode = null; // ì½”ë“œ ì´ˆê¸°í™”
                // onAuthStateChangedê°€ ìë™ìœ¼ë¡œ ë¯¸ë‹ˆí™ˆí”¼ ë·°ë¡œ ì´ë™ì‹œí‚´
                
            } catch (error) {
                console.error("Error signing up:", error);
                if (error.code === 'auth/email-already-in-use') {
                    showError("ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.");
                } else {
                    showError(`ê°€ì… ì‹¤íŒ¨: ${error.message}`);
                }
            } finally {
                showLoading(false);
            }
        });

        // 5. ë¡œê·¸ì¸ ì²˜ë¦¬
        document.getElementById('login-submit-btn').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showError("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            showLoading(true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChangedê°€ ìë™ìœ¼ë¡œ ë¯¸ë‹ˆí™ˆí”¼ ë·°ë¡œ ì´ë™ì‹œí‚´
            } catch (error) {
                console.error("Error logging in:", error);
                showError("ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            } finally {
                showLoading(false);
            }
        });

        // 6. ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        document.getElementById('logout-btn').addEventListener('click', async () => {
            showLoading(true);
            await signOut(auth);
            // onAuthStateChangedê°€ ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ ë·°ë¡œ ì´ë™ì‹œí‚´
        });

        // 7. ë¯¸ë‹ˆí™ˆí”¼ ë„¤ë¹„ê²Œì´ì…˜
        document.querySelectorAll('.menu-item[data-target]').forEach(item => {
            item.addEventListener('click', (e) => {
                const targetId = e.target.getAttribute('data-target');
                
                // ëª¨ë“  ì„¹ì…˜ ë¹„í™œì„±í™”
                document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
                // ëª¨ë“  ë©”ë‰´ ë¹„í™œì„±í™”
                document.querySelectorAll('.menu-item[data-target]').forEach(menu => menu.classList.remove('active'));

                // íƒ€ê²Ÿ ì„¹ì…˜ í™œì„±í™”
                document.getElementById(`content-${targetId}`).classList.add('active');
                // íƒ€ê²Ÿ ë©”ë‰´ í™œì„±í™”
                e.target.classList.add('active');
            });
        });

        // 8. í”„ë¡œí•„ ìˆ˜ì •
        const editProfileModal = document.getElementById('edit-profile-modal');
        
        document.getElementById('edit-profile-btn').addEventListener('click', () => {
            // í˜„ì¬ í”„ë¡œí•„ ì •ë³´ë¡œ ëª¨ë‹¬ ì±„ìš°ê¸°
            document.getElementById('edit-nickname').value = userProfile.nickname;
            document.getElementById('edit-bio').value = userProfile.bio || "";
            document.getElementById('edit-interests').value = userProfile.interests ? userProfile.interests.join(', ') : "";
            document.getElementById('edit-visibility').value = userProfile.visibility || "public";
            editProfileModal.classList.remove('hidden');
        });

        document.getElementById('cancel-edit-profile-btn').addEventListener('click', () => {
            editProfileModal.classList.add('hidden');
        });

        document.getElementById('save-edit-profile-btn').addEventListener('click', async () => {
            const newNickname = document.getElementById('edit-nickname').value;
            const newBio = document.getElementById('edit-bio').value;
            const newInterests = document.getElementById('edit-interests').value.split(',').map(s => s.trim()).filter(Boolean);
            const newVisibility = document.getElementById('edit-visibility').value;
            const newFile = document.getElementById('edit-profile-pic').files[0];

            if (!newNickname || !nicknameRegex.test(newNickname)) {
                showError("ë³„ëª…ì€ 2~10ìì˜ í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }

            showLoading(true);
            
            try {
                // ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€, ì¤‘ë³µë˜ëŠ”ì§€ í™•ì¸
                if (newNickname !== userProfile.nickname) {
                    const nicknameQuery = query(collection(db, "users"), where("nickname", "==", newNickname));
                    const nicknameSnapshot = await getDocs(nicknameQuery);
                    if (!nicknameSnapshot.empty) {
                        showError("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë³„ëª…ì…ë‹ˆë‹¤.");
                        showLoading(false);
                        return;
                    }
                }

                const updateData = {
                    nickname: newNickname,
                    bio: newBio,
                    interests: newInterests,
                    visibility: newVisibility
                };

                // ìƒˆ í”„ë¡œí•„ ì‚¬ì§„ì´ ìˆëŠ” ê²½ìš°
                if (newFile) {
                    if (newFile.size > 5 * 1024 * 1024) { // 5MB
                        showError("íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        showLoading(false);
                        return;
                    }
                    const storageRef = ref(storage, `profilePics/${currentUser.uid}/${newFile.name}`);
                    await uploadBytes(storageRef, newFile);
                    updateData.profilePicUrl = await getDownloadURL(storageRef);
                }

                // Firestore ì—…ë°ì´íŠ¸
                const userDocRef = doc(db, "users", currentUser.uid);
                await updateDoc(userDocRef, updateData);

                // ë¡œì»¬ í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ë° UI ê°±ì‹ 
                userProfile = { ...userProfile, ...updateData };
                renderProfileData(userProfile);

                editProfileModal.classList.add('hidden');

            } catch (error) {
                console.error("Error updating profile:", error);
                showError(`í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            } finally {
                showLoading(false);
            }
        });

        // 9. ë‹¤ì´ì–´ë¦¬ (ê²Œì‹œê¸€)
        const postsList = document.getElementById('posts-list');
        let postsUnsubscribe = null;

        function loadPosts(uid) {
            if (postsUnsubscribe) postsUnsubscribe(); // ì´ì „ ë¦¬ìŠ¤ë„ˆ í•´ì œ

            const postsQuery = query(collection(db, "posts"), where("authorId", "==", uid));
            
            postsUnsubscribe = onSnapshot(postsQuery, (snapshot) => {
                postsList.innerHTML = ''; // ëª©ë¡ ë¹„ìš°ê¸°
                if (snapshot.empty) {
                    postsList.innerHTML = '<p class="text-gray-500 text-center">ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                snapshot.docs
                    .sort((a, b) => b.data().createdAt.seconds - a.data().createdAt.seconds) // JSì—ì„œ ì •ë ¬
                    .forEach(doc => {
                        const post = doc.data();
                        const postEl = document.createElement('div');
                        postEl.className = 'card';
                        postEl.innerHTML = `
                            <div class="flex items-center mb-2">
                                <img src="${userProfile.profilePicUrl}" alt="${userProfile.nickname}" class="w-10 h-10 rounded-full mr-3">
                                <div>
                                    <p class="font-semibold">${userProfile.nickname}</p>
                                    <p class="text-sm text-gray-500">${new Date(post.createdAt?.toDate()).toLocaleString()}</p>
                                </div>
                            </div>
                            <p class="text-gray-800 mb-3 whitespace-pre-wrap">${post.content}</p>
                            ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" class="rounded-lg max-w-full h-auto mt-2">` : ''}
                        `;
                        postsList.appendChild(postEl);
                    });
            }, (error) => {
                console.error("Error loading posts:", error);
                showError("ê²Œì‹œê¸€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }

        document.getElementById('create-post-btn').addEventListener('click', async () => {
            const content = document.getElementById('post-content-input').value;
            const file = document.getElementById('post-image-input').files[0];

            if (!content) {
                showError("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            showLoading(true);
            try {
                let imageUrl = null;
                if (file) {
                    if (file.size > 10 * 1024 * 1024) { // 10MB
                        showError("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        showLoading(false);
                        return;
                    }
                    const storageRef = ref(storage, `postImages/${currentUser.uid}/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    imageUrl = await getDownloadURL(storageRef);
                }

                await addDoc(collection(db, "posts"), {
                    authorId: currentUser.uid,
                    authorNickname: userProfile.nickname,
                    content: content,
                    imageUrl: imageUrl,
                    class: "1-3",
                    createdAt: serverTimestamp()
                });

                document.getElementById('post-content-input').value = '';
                document.getElementById('post-image-input').value = '';

            } catch (error) {
                console.error("Error creating post:", error);
                showError(`ê¸€ì“°ê¸° ì‹¤íŒ¨: ${error.message}`);
            } finally {
                showLoading(false);
            }
        });

        // 10. ë°©ëª…ë¡
        const guestbookList = document.getElementById('guestbook-list');
        let guestbookUnsubscribe = null;
        let guestbookAuthorsCache = {}; // ë°©ëª…ë¡ ì‘ì„±ì í”„ë¡œí•„ ìºì‹œ

        async function getGuestbookAuthor(uid) {
            if (guestbookAuthorsCache[uid]) {
                return guestbookAuthorsCache[uid];
            }
            try {
                const userDoc = await getDoc(doc(db, "users", uid));
                if (userDoc.exists()) {
                    const authorData = userDoc.data();
                    guestbookAuthorsCache[uid] = {
                        nickname: authorData.nickname,
                        profilePicUrl: authorData.profilePicUrl
                    };
                    return guestbookAuthorsCache[uid];
                }
            } catch (error) {
                console.error("Error fetching guestbook author:", error);
            }
            return { nickname: "ì•Œìˆ˜ì—†ìŒ", profilePicUrl: "https://placehold.co/40x40/e0e0e0/757575?text=?" };
        }

        function loadGuestbook(ownerUid) {
            if (guestbookUnsubscribe) guestbookUnsubscribe();

            const guestbookQuery = query(collection(db, "guestbook"), where("ownerId", "==", ownerUid));

            guestbookUnsubscribe = onSnapshot(guestbookQuery, async (snapshot) => {
                guestbookList.innerHTML = '';
                if (snapshot.empty) {
                    guestbookList.innerHTML = '<p class="text-gray-500 text-center">ë°©ëª…ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                // onSnapshot ì½œë°± ë‚´ì—ì„œ ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•´ Promise.all ì‚¬ìš©
                const sortedDocs = snapshot.docs.sort((a, b) => b.data().createdAt.seconds - a.data().createdAt.seconds);
                
                for (const doc of sortedDocs) {
                    const entry = doc.data();
                    const author = await getGuestbookAuthor(entry.authorId);
                    
                    const entryEl = document.createElement('div');
                    entryEl.className = 'card flex';
                    entryEl.innerHTML = `
                        <img src="${author.profilePicUrl}" alt="${author.nickname}" class="w-10 h-10 rounded-full mr-3 flex-shrink-0">
                        <div>
                            <p class="font-semibold">${author.nickname} <span class="text-sm text-gray-500 font-normal">${new Date(entry.createdAt?.toDate()).toLocaleString()}</span></p>
                            <p class="text-gray-800 whitespace-pre-wrap">${entry.content}</p>
                        </div>
                    `;
                    guestbookList.appendChild(entryEl);
                }
            }, (error) => {
                console.error("Error loading guestbook:", error);
                showError("ë°©ëª…ë¡ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }

        document.getElementById('create-guestbook-btn').addEventListener('click', async () => {
            const content = document.getElementById('guestbook-content-input').value;
            if (!content) {
                showError("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            showLoading(true);
            try {
                await addDoc(collection(db, "guestbook"), {
                    ownerId: currentUser.uid, // í™ˆí”¼ ì£¼ì¸ ID
                    authorId: currentUser.uid, // ì‘ì„±ì ID (ì‹¤ì œë¡œëŠ” ë°©ë¬¸ì IDì—¬ì•¼ í•¨. ì´ ë°ëª¨ì—ì„œëŠ” í¸ì˜ìƒ ìê¸° ìì‹ )
                    // ì´ ë°ëª¨ëŠ” ìì‹ ì˜ í™ˆí”¼ë§Œ ë³´ë¯€ë¡œ, ì‹¤ì œë¡œëŠ” íƒ€ì¸ì˜ í™ˆí”¼ ID (ownerId)ê°€ í•„ìš”í•©ë‹ˆë‹¤.
                    // ì´ ì½”ë“œì—ì„œëŠ” 'ë‚´ ë°©ëª…ë¡ì— ë‚´ê°€ ì“°ê¸°'ë¡œ ë™ì‘í•©ë‹ˆë‹¤.
                    content: content,
                    createdAt: serverTimestamp()
                });
                document.getElementById('guestbook-content-input').value = '';
            } catch (error) {
                console.error("Error writing guestbook:", error);
                showError(`ë°©ëª…ë¡ ì‘ì„± ì‹¤íŒ¨: ${error.message}`);
            } finally {
                showLoading(false);
            }
        });

    </script>
</body>
</html>

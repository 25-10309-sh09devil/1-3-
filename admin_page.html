<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3-1반 미니홈피 - 관리자</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: '굴림', Gulim, sans-serif;
            background: #c5d9f1 url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><rect width="20" height="20" fill="%23b8d0eb"/><circle cx="10" cy="10" r="1" fill="%23fff" opacity="0.3"/></svg>');
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(180deg, #ff9966 0%, #ff6633 100%);
            padding: 20px;
            text-align: center;
            border: 3px solid #cc4422;
            border-radius: 15px 15px 0 0;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            color: white;
            font-size: 2em;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            margin-bottom: 5px;
        }

        .header p {
            color: #fff5e6;
            font-size: 0.9em;
        }

        .back-btn {
            position: absolute;
            top: 15px;
            left: 20px;
            padding: 8px 15px;
            background: white;
            border: 2px solid #ffcc99;
            border-radius: 5px;
            cursor: pointer;
            font-family: '굴림', Gulim, sans-serif;
            font-size: 0.9em;
            color: #ff6633;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: #fff5e6;
        }

        .content {
            background: white;
            border: 3px solid #cc4422;
            border-top: none;
            border-radius: 0 0 15px 15px;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ffcc99;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #ffcc99;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-family: '굴림', Gulim, sans-serif;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: #fff5e6;
        }

        .tab-btn.active {
            background: #ff6633;
            color: white;
            border-color: #cc4422;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fff5e6 0%, #ffebcc 100%);
            border: 2px solid #ffcc99;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-card h3 {
            color: #ff6633;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .stat-card .number {
            color: #cc4422;
            font-size: 2.5em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .user-table th {
            background: #ff6633;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 0.9em;
            border: 2px solid #cc4422;
        }

        .user-table td {
            padding: 12px;
            border: 1px solid #ffcc99;
            font-size: 0.9em;
        }

        .user-table tr:nth-child(even) {
            background: #fff5e6;
        }

        .user-table tr:hover {
            background: #ffebcc;
        }

        .delete-btn {
            background: #ff3333;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .delete-btn:hover {
            background: #cc0000;
        }

        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ffcc99;
            border-radius: 5px;
            font-family: '굴림', Gulim, sans-serif;
        }

        .search-box button {
            padding: 10px 20px;
            background: #ff6633;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: '굴림', Gulim, sans-serif;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #ff6633;
            font-size: 1.2em;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .comment-item {
            background: #fff5e6;
            border: 2px solid #ffcc99;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dotted #ffcc99;
        }

        .comment-author {
            color: #ff6633;
            font-weight: bold;
        }

        .comment-meta {
            color: #999;
            font-size: 0.85em;
        }

        .comment-text {
            color: #333;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .admin-note {
            background: #fff9e6;
            border: 2px dotted #ffcc66;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #996600;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .ip-info {
            background: #e6f7ff;
            border: 2px solid #91d5ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .ip-info h3 {
            color: #0066cc;
            margin-bottom: 10px;
        }

        .ip-info code {
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            color: #ff6633;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">← 돌아가기</a>
            <h1>🔐 관리자 페이지</h1>
            <p>3-1반 미니홈피 관리</p>
        </div>

        <div class="content">
            <div class="admin-note">
                <strong>⚠️ 관리자 권한 안내</strong><br>
                • 이 페이지는 config.js에 등록된 IP 주소에서만 접근 가능합니다<br>
                • 사용자 정보 조회, 댓글 삭제, 통계 확인 등을 할 수 있습니다<br>
                • 관리자 권한은 신중하게 사용해주세요
            </div>

            <div class="ip-info" id="ipInfo">
                <h3>현재 접속 IP</h3>
                <div>IP 주소: <code id="currentIP">확인중...</code></div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="stats">📊 통계</button>
                <button class="tab-btn" data-tab="users">👥 회원 관리</button>
                <button class="tab-btn" data-tab="comments">💬 댓글 관리</button>
                <button class="tab-btn" data-tab="guestbook">✏️ 방명록 관리</button>
            </div>

            <!-- 통계 탭 -->
            <div class="tab-content active" id="stats-tab">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>총 회원 수</h3>
                        <div class="number" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>총 댓글 수</h3>
                        <div class="number" id="totalComments">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>방명록 수</h3>
                        <div class="number" id="totalGuestbook">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>사진 수</h3>
                        <div class="number" id="totalPhotos">0</div>
                    </div>
                </div>

                <h3 style="color: #ff6633; margin-bottom: 15px;">최근 가입 회원</h3>
                <div id="recentUsers"></div>
            </div>

            <!-- 회원 관리 탭 -->
            <div class="tab-content" id="users-tab">
                <div class="search-box">
                    <input type="text" id="userSearch" placeholder="이름, 별명, 학번으로 검색...">
                    <button onclick="searchUsers()">검색</button>
                </div>

                <div id="usersContainer">
                    <div class="loading">회원 목록을 불러오는 중...</div>
                </div>
            </div>

            <!-- 댓글 관리 탭 -->
            <div class="tab-content" id="comments-tab">
                <div class="search-box">
                    <input type="text" id="commentSearch" placeholder="작성자, 내용으로 검색...">
                    <button onclick="searchComments()">검색</button>
                </div>

                <div id="commentsContainer">
                    <div class="loading">댓글 목록을 불러오는 중...</div>
                </div>
            </div>

            <!-- 방명록 관리 탭 -->
            <div class="tab-content" id="guestbook-tab">
                <div class="search-box">
                    <input type="text" id="guestbookSearch" placeholder="작성자, 내용으로 검색...">
                    <button onclick="searchGuestbook()">검색</button>
                </div>

                <div id="guestbookContainer">
                    <div class="loading">방명록을 불러오는 중...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAlR_ctIhpsykWYJi_W6iYIeM3lUpFe5Pk",
            authDomain: "pr-2128d.firebaseapp.com",
            projectId: "pr-2128d",
            storageBucket: "pr-2128d.firebasestorage.app",
            messagingSenderId: "915082414403",
            appId: "1:915082414403:web:1dbb554c05288b09a387f6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let CONFIG;
        let allUsers = [];
        let allComments = [];
        let allGuestbook = [];

        // 관리자 권한 확인
        async function checkAdmin() {
            const userStr = localStorage.getItem('minihompy_user');
            if (!userStr) {
                alert('로그인이 필요합니다.');
                window.location.href = 'auth.html';
                return false;
            }

            while (!window.CONFIG) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            CONFIG = window.CONFIG;

            const userIP = await getUserIP();
            document.getElementById('currentIP').textContent = userIP || '확인 실패';

            if (!CONFIG.adminIPs || !CONFIG.adminIPs.includes(userIP)) {
                alert('관리자 권한이 없습니다.');
                window.location.href = 'index.html';
                return false;
            }

            return true;
        }

        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('IP 조회 실패:', error);
                return null;
            }
        }

        // 탭 전환
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(section => section.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
            });
        });

        // 통계 로드
        async function loadStats() {
            try {
                // 회원 수
                const usersSnapshot = await getDocs(collection(db, 'users'));
                document.getElementById('totalUsers').textContent = usersSnapshot.size;

                // 댓글 수
                let totalComments = 0;
                if (CONFIG && CONFIG.posts) {
                    for (let i = 0; i < CONFIG.posts.length; i++) {
                        const commentsSnapshot = await getDocs(collection(db, `posts/${i}/comments`));
                        totalComments += commentsSnapshot.size;
                    }
                }
                document.getElementById('totalComments').textContent = totalComments;

                // 방명록 수
                const guestbookSnapshot = await getDocs(collection(db, 'guestbook'));
                document.getElementById('totalGuestbook').textContent = guestbookSnapshot.size;

                // 사진 수
                document.getElementById('totalPhotos').textContent = CONFIG.photos ? CONFIG.photos.length : 0;

                // 최근 가입 회원
                const q = query(collection(db, 'users'), orderBy('registeredAt', 'desc'), limit(5));
                const recentSnapshot = await getDocs(q);
                
                let html = '<table class="user-table"><thead><tr><th>별명</th><th>이름</th><th>학번</th><th>가입일</th></tr></thead><tbody>';
                recentSnapshot.forEach(doc => {
                    const user = doc.data();
                    const date = user.registeredAt ? new Date(user.registeredAt.seconds * 1000).toLocaleDateString('ko-KR') : '-';
                    html += `<tr>
                        <td>${user.nickname}</td>
                        <td>${user.name}</td>
                        <td>${user.studentId}</td>
                        <td>${date}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                
                document.getElementById('recentUsers').innerHTML = html;

            } catch (error) {
                console.error('통계 로드 실패:', error);
            }
        }

        // 회원 관리
        async function loadUsers() {
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                allUsers = [];
                snapshot.forEach(doc => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });

                displayUsers(allUsers);
            } catch (error) {
                console.error('회원 목록 로드 실패:', error);
                document.getElementById('usersContainer').innerHTML = '<div class="empty-state">회원 목록을 불러올 수 없습니다.</div>';
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="empty-state">등록된 회원이 없습니다.</div>';
                return;
            }

            let html = `<table class="user-table">
                <thead>
                    <tr>
                        <th>별명</th>
                        <th>이름</th>
                        <th>학번</th>
                        <th>가입일</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>`;

            users.forEach(user => {
                const date = user.registeredAt ? new Date(user.registeredAt.seconds * 1000).toLocaleString('ko-KR') : '-';
                html += `<tr>
                    <td>${user.nickname}</td>
                    <td>${user.name}</td>
                    <td>${user.studentId}</td>
                    <td>${date}</td>
                    <td><button class="delete-btn" onclick="deleteUser('${user.id}', '${user.name}')">삭제</button></td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        window.searchUsers = function() {
            const keyword = document.getElementById('userSearch').value.toLowerCase();
            if (!keyword) {
                displayUsers(allUsers);
                return;
            }

            const filtered = allUsers.filter(user => 
                user.nickname.toLowerCase().includes(keyword) ||
                user.name.toLowerCase().includes(keyword) ||
                user.studentId.includes(keyword)
            );

            displayUsers(filtered);
        }

        window.deleteUser = async function(userId, userName) {
            if (!confirm(`${userName} 회원을 삭제하시겠습니까?`)) return;

            try {
                await deleteDoc(doc(db, 'users', userId));
                alert('회원이 삭제되었습니다.');
                await loadUsers();
                await loadStats();
            } catch (error) {
                console.error('회원 삭제 실패:', error);
                alert('회원 삭제에 실패했습니다.');
            }
        }

        // 댓글 관리
        async function loadComments() {
            try {
                allComments = [];
                
                if (CONFIG && CONFIG.posts) {
                    for (let i = 0; i < CONFIG.posts.length; i++) {
                        const snapshot = await getDocs(query(collection(db, `posts/${i}/comments`), orderBy('timestamp', 'desc')));
                        snapshot.forEach(doc => {
                            allComments.push({
                                id: doc.id,
                                postIndex: i,
                                postTitle: CONFIG.posts[i].title,
                                ...doc.data()
                            });
                        });
                    }
                }

                displayComments(allComments);
            } catch (error) {
                console.error('댓글 로드 실패:', error);
                document.getElementById('commentsContainer').innerHTML = '<div class="empty-state">댓글을 불러올 수 없습니다.</div>';
            }
        }

        function displayComments(comments) {
            const container = document.getElementById('commentsContainer');
            
            if (comments.length === 0) {
                container.innerHTML = '<div class="empty-state">등록된 댓글이 없습니다.</div>';
                return;
            }

            let html = '';
            comments.forEach(comment => {
                const time = comment.timestamp ? new Date(comment.timestamp.seconds * 1000).toLocaleString('ko-KR') : '';
                html += `
                    <div class="comment-item">
                        <div class="comment-header">
                            <div>
                                <div class="comment-author">${comment.nickname} (${comment.name})</div>
                                <div class="comment-meta">게시글: ${comment.postTitle}</div>
                            </div>
                            <button class="delete-btn" onclick="deleteComment(${comment.postIndex}, '${comment.id}')">삭제</button>
                        </div>
                        <div class="comment-text">${comment.text}</div>
                        <div class="comment-meta">${time}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        window.searchComments = function() {
            const keyword = document.getElementById('commentSearch').value.toLowerCase();
            if (!keyword) {
                displayComments(allComments);
                return;
            }

            const filtered = allComments.filter(comment => 
                comment.nickname.toLowerCase().includes(keyword) ||
                comment.name.toLowerCase().includes(keyword) ||
                comment.text.toLowerCase().includes(keyword)
            );

            displayComments(filtered);
        }

        window.deleteComment = async function(postIndex, commentId) {
            if (!confirm('댓글을 삭제하시겠습니까?')) return;

            try {
                await deleteDoc(doc(db, `posts/${postIndex}/comments`, commentId));
                alert('댓글이 삭제되었습니다.');
                await loadComments();
                await loadStats();
            } catch (error) {
                console.error('댓글 삭제 실패:', error);
                alert('댓글 삭제에 실패했습니다.');
            }
        }

        // 방명록 관리
        async function loadGuestbook() {
            try {
                const snapshot = await getDocs(query(collection(db, 'guestbook'), orderBy('timestamp', 'desc')));
                allGuestbook = [];
                snapshot.forEach(doc => {
                    allGuestbook.push({ id: doc.id, ...doc.data() });
                });

                displayGuestbook(allGuestbook);
            } catch (error) {
                console.error('방명록 로드 실패:', error);
                document.getElementById('guestbookContainer').innerHTML = '<div class="empty-state">방명록을 불러올 수 없습니다.</div>';
            }
        }

        function displayGuestbook(entries) {
            const container = document.getElementById('guestbookContainer');
            
            if (entries.length === 0) {
                container.innerHTML = '<div class="empty-state">등록된 방명록이 없습니다.</div>';
                return;
            }

            let html = '';
            entries.forEach(entry => {
                const time = entry.timestamp ? new Date(entry.timestamp.seconds * 1000).toLocaleString('ko-KR') : '';
                html += `
                    <div class="comment-item">
                        <div class="comment-header">
                            <div class="comment-author">${entry.nickname} (${entry.name})</div>
                            <button class="delete-btn" onclick="deleteGuestbookEntry('${entry.id}')">삭제</button>
                        </div>
                        <div class="comment-text">${entry.text.replace(/\n/g, '<br>')}</div>
                        <div class="comment-meta">${time}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        window.searchGuestbook = function() {
            const keyword = document.getElementById('guestbookSearch').value.toLowerCase();
            if (!keyword) {
                displayGuestbook(allGuestbook);
                return;
            }

            const filtered = allGuestbook.filter(entry => 
                entry.nickname.toLowerCase().includes(keyword) ||
                entry.name.toLowerCase().includes(keyword) ||
                entry.text.toLowerCase().includes(keyword)
            );

            displayGuestbook(filtered);
        }

        window.deleteGuestbookEntry = async function(entryId) {
            if (!confirm('방명록을 삭제하시겠습니까?')) return;

            try {
                await deleteDoc(doc(db, 'guestbook', entryId));
                alert('방명록이 삭제되었습니다.');
                await loadGuestbook();
                await loadStats();
            } catch (error) {
                console.error('방명록 삭제 실패:', error);
                alert('방명록 삭제에 실패했습니다.');
            }
        }

        // 초기화
        window.addEventListener('load', async () => {
            const isAuthorized = await checkAdmin();
            if (isAuthorized) {
                await loadStats();
                await loadUsers();
                await loadComments();
                await loadGuestbook();
            }
        });
    </script>
</body>
</html>
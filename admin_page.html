<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>관리자 페이지 - 미니홈피</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Noto Sans KR", "Apple SD Gothic Neo"; padding:18px; background:#f7f7f7; }
    .card { background:#fff; padding:12px; border-radius:8px; border:1px solid #e3e3e3; margin-bottom:12px; }
    h1 { margin-top:0; }
    input[type="text"]{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%;}
    .row{display:flex;gap:8px;align-items:center;}
    .btn{padding:8px 12px;border-radius:6px;border:0;cursor:pointer;}
    .btn-primary{background:#1976d2;color:#fff;}
  </style>
</head>
<body>
  <h1>관리자 페이지</h1>
  <div id="status"></div>

  <section class="card">
    <h3>관리자 인증</h3>
    <div class="row">
      <div style="flex:1">
        <div>로그인 사용자: <span id="admin-user">없음</span></div>
      </div>
      <div>
        <button id="btn-login" class="btn btn-primary">로그인 (Google)</button>
        <button id="btn-logout" class="btn" style="display:none">로그아웃</button>
      </div>
    </div>
    <div class="small" style="margin-top:8px;">※ 운영 환경에서는 Firebase Admin SDK로 custom claims를 사용해 admin 권한을 부여하는 것을 권장합니다.</div>
  </section>

  <section class="card">
    <h3>BGM 업로드</h3>
    <input id="bgm-file" type="file" accept="audio/*" />
    <div style="margin-top:8px">
      <button id="upload-bgm" class="btn btn-primary">업로드</button>
    </div>
    <div id="bgm-list" style="margin-top:12px"></div>
  </section>

  <section class="card">
    <h3>통계</h3>
    <div id="stats"></div>
  </section>

  <section class="card">
    <h3>신고된 게시물</h3>
    <div id="reports"></div>
  </section>

  <section class="card">
    <h3>관리자 할당(간단)</h3>
    <div class="small">UID를 입력해 admins 컬렉션에 추가합니다. (운영 시에는 서버에서 custom claim으로 처리하세요.)</div>
    <input id="admin-uid" type="text" placeholder="UID 입력" />
    <div style="margin-top:8px">
      <button id="grant-admin" class="btn btn-primary">관리자 부여</button>
      <button id="revoke-admin" class="btn">관리자 해제</button>
    </div>
  </section>

  <aside class="card">
    <h4>주의</h4>
    <ul>
      <li>이 페이지는 admins 컬렉션을 참조해 관리자 UI를 노출합니다. 서버에서 custom claim을 설정하는 것이 안전합니다.</li>
      <li>영구 삭제 등 강력한 권한을 테스트 전 충분히 검토하세요.</li>
    </ul>
  </aside>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, onSnapshot, query, where, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, listAll, deleteObject } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAlR_ctIhpsykWYJi_W6iYIeM3lUpFe5Pk",
      authDomain: "pr-2128d.firebaseapp.com",
      projectId: "pr-2128d",
      storageBucket: "pr-2128d.firebasestorage.app",
      messagingSenderId: "915082414403",
      appId: "1:915082414403:web:1dbb554c05288b09a387f6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const adminUserSpan = document.getElementById('admin-user');
    const status = document.getElementById('status');

    const bgmFileInput = document.getElementById('bgm-file');
    const uploadBgmBtn = document.getElementById('upload-bgm');
    const bgmList = document.getElementById('bgm-list');
    const statsDiv = document.getElementById('stats');
    const reportsDiv = document.getElementById('reports');

    const grantAdminBtn = document.getElementById('grant-admin');
    const revokeAdminBtn = document.getElementById('revoke-admin');
    const adminUidInput = document.getElementById('admin-uid');

    let currentUser = null;
    let isAdmin = false;

    document.addEventListener('DOMContentLoaded', () => {
      btnLogin.addEventListener('click', async () => {
        const p = new GoogleAuthProvider();
        try {
          await signInWithPopup(auth, p);
        } catch (e) { console.error(e); alert('로그인 실패: '+e.message); }
      });
      btnLogout.addEventListener('click', async () => { await signOut(auth); alert('로그아웃'); });

      uploadBgmBtn.addEventListener('click', uploadBgm);
      grantAdminBtn.addEventListener('click', grantAdmin);
      revokeAdminBtn.addEventListener('click', revokeAdmin);

      loadBgmList();
      loadReports();
      loadStats();
    });

    onAuthStateChanged(auth, async (u) => {
      currentUser = u;
      if (u) {
        adminUserSpan.textContent = u.displayName || u.uid;
        btnLogin.style.display = 'none';
        btnLogout.style.display = 'inline-block';
        // check admins collection
        const aDoc = await getDoc(doc(db, 'admins', u.uid));
        isAdmin = aDoc.exists();
        if (!isAdmin) status.innerHTML = '<div style="color:#d00">관리자 권한이 없습니다.</div>';
        else status.innerHTML = '<div style="color:green">관리자 권한 확인됨.</div>';
      } else {
        adminUserSpan.textContent = '없음';
        btnLogin.style.display = 'inline-block';
        btnLogout.style.display = 'none';
        status.innerHTML = '<div>로그인하세요.</div>';
      }
    });

    // 上传 BGM
    async function uploadBgm() {
      if (!currentUser) { alert('로그인 필요'); return; }
      if (!isAdmin) { alert('관리자 권한 필요'); return; }
      const f = bgmFileInput.files && bgmFileInput.files[0];
      if (!f) { alert('파일 선택'); return; }
      const p = `bgm/${Date.now()}_${f.name}`;
      const r = storageRef(storage, p);
      await uploadBytes(r, f);
      const url = await getDownloadURL(r);
      await addDoc(collection(db, 'bgm'), { path: p, url, name: f.name, createdAt: serverTimestamp() });
      alert('BGM 업로드됨');
      loadBgmList();
    }

    async function loadBgmList() {
      bgmList.innerHTML = '로딩...';
      const snap = await getDocs(collection(db, 'bgm'));
      bgmList.innerHTML = '';
      snap.forEach(d => {
        const it = d.data();
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<div><strong>${escapeHtml(it.name)}</strong> (${it.path})<div style="margin-top:8px"><audio controls src="${it.url}"></audio><div style="margin-top:6px"><button class="btn" data-path="${it.path}">삭제</button></div></div></div>`;
        div.querySelector('button').addEventListener('click', async (e) => {
          if (!confirm('삭제하시겠습니까?')) return;
          const p = e.currentTarget.dataset.path;
          try {
            await deleteObject(storageRef(storage, p));
            // remove doc - naive search by path
            const snap2 = await getDocs(query(collection(db, 'bgm'), where('path','==',p)));
            snap2.forEach(async dd => { await deleteDoc(doc(db, 'bgm', dd.id)); });
            alert('삭제됨'); loadBgmList();
          } catch (err) { console.error(err); alert('삭제 실패: '+err.message); }
        });
        bgmList.appendChild(div);
      });
    }

    async function loadStats() {
      statsDiv.innerHTML = '로딩...';
      const usersSnap = await getDocs(collection(db, 'users'));
      const postsSnap = await getDocs(collection(db, 'posts'));
      const photosSnap = await getDocs(collection(db, 'photos'));
      statsDiv.innerHTML = `<div>사용자 수: ${usersSnap.size}</div><div>게시글 수: ${postsSnap.size}</div><div>사진 수: ${photosSnap.size}</div>`;
    }

    async function loadReports() {
      reportsDiv.innerHTML = '로딩...';
      const snap = await getDocs(collection(db, 'reports'));
      reportsDiv.innerHTML = '';
      snap.forEach(d => {
        const it = d.data();
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<div><strong>신고자:</strong> ${escapeHtml(it.from)} <strong>대상:</strong> ${escapeHtml(it.targetId)} <div class="small">${it.reason || ''}</div><div style="margin-top:8px"><button class="btn btn-primary take-action" data-id="${d.id}">조치(삭제)</button></div></div>`;
        div.querySelector('.take-action').addEventListener('click', async (e) => {
          const id = e.currentTarget.dataset.id;
          if (!confirm('해당 리소스를 삭제합니까?')) return;
          // simple: delete reported doc if exists in posts/photos
          const rdoc = await getDoc(doc(db, 'reports', id));
          if (!rdoc.exists()) return;
          const data = rdoc.data();
          try {
            if (data.collection && data.targetId) {
              await deleteDoc(doc(db, data.collection, data.targetId));
            }
            await deleteDoc(doc(db, 'reports', id));
            alert('조치 완료');
            loadReports();
          } catch(err) { console.error(err); alert('조치 실패: '+err.message); }
        });
        reportsDiv.appendChild(div);
      });
    }

    async function grantAdmin() {
      if (!currentUser) { alert('로그인 필요'); return; }
      if (!isAdmin) { alert('관리자 권한 필요'); return; }
      const uid = adminUidInput.value.trim();
      if (!uid) { alert('UID 입력'); return; }
      await setDoc(doc(db, 'admins', uid), { grantedBy: currentUser.uid, createdAt: serverTimestamp() });
      alert('관리자 할당 완료 (admins 컬렉션에 추가됨)');
    }

    async function revokeAdmin() {
      if (!currentUser) { alert('로그인 필요'); return; }
      if (!isAdmin) { alert('관리자 권한 필요'); return; }
      const uid = adminUidInput.value.trim();
      if (!uid) { alert('UID 입력'); return; }
      await deleteDoc(doc(db, 'admins', uid));
      alert('관리자 해제 완료');
    }

    function escapeHtml(str = '') { return String(str).replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
  </script>
</body>
</html>
